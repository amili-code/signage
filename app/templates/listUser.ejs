<%- include('./layout/head'); %>

    <!-- Main content -->
    <main class="main">

        <!-- Breadcrumb -->
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/">Ø®Ø§Ù†Ù‡</a></li>
            <li class="breadcrumb-item active">Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</li>
            <li class="breadcrumb-item ">Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±</li>

            <!-- <li class="breadcrumb-menu">
                <div class="btn-group" role="group" aria-label="Button group with nested dropdown">
                    <a class="btn btn-secondary" href="#"><i class="icon-speech"></i></a>
                    <a class="btn btn-secondary" href="./"><i class="icon-graph"></i> &nbsp;Ø¯Ø§Ø´Ø¨Ø±Ø¯</a>
                    <a class="btn btn-secondary" href="#"><i class="icon-settings"></i> &nbsp;ØªÙ†Ø¸ÛŒÙ…Ø§Øª</a>
                </div>
            </li> -->
        </ol>

        <div class="container-fluid">

            <div class="animated fadeIn">
                <div class="row container-fluid" id="addUser">
                    <input type="text" id="searchInput" class="form-control mb-3 input-sm" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±..." oninput="renderTable()">
                    <br>
                    <div class="card">
    <div class="card-header">
        <i class="fa fa-align-justify"></i> Ø¬Ø¯ÙˆÙ„ <strong>Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</strong>
    </div>
    <div class="card-body">
        
        <table class="table table-condensed">
            <thead>
                <tr>
                    <th style="cursor:pointer">Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ </th>
                    <th onclick="sortTable('createdAt')" style="cursor:pointer">ØªØ§Ø±ÛŒØ® Ø§ÛŒØ¬Ø§Ø¯ ğŸ”½</th>
                    <th>Ø³Ø·Ø­ Ø¯Ø³ØªØ±Ø³ÛŒ</th>
                    <th>Ø­Ø°Ù</th>
                </tr>
            </thead>
            <tbody id="userTable"></tbody>
        </table>
        <div class="row" style="text-align: center;">
            <ul id="pagination" class="pagination"></ul>
        </div>
    </div>
</div>

                </div>
            </div>

        </div>
        <!--/.container-fluid-->
    </main>





<script>
    let usersData = []; // Ø°Ø®ÛŒØ±Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¨Ø±Ø§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª Ø¨Ù‡ØªØ±
let currentPage = 1;
const rowsPerPage = 5; // ØªØ¹Ø¯Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¯Ø± Ù‡Ø± ØµÙØ­Ù‡

async function fetchAndPopulateTable() {
    try {
        const response = await fetch("http://localhost:5000/api/user");
        if (!response.ok) throw new Error("Ù…Ø´Ú©Ù„ÛŒ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ù‡ ÙˆØ¬ÙˆØ¯ Ø¢Ù…Ø¯Ù‡ Ø§Ø³Øª.");

        usersData = await response.json();
        renderTable(); // Ù†Ù…Ø§ÛŒØ´ Ø¬Ø¯ÙˆÙ„ Ù¾Ø³ Ø§Ø² Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§

    } catch (error) {
        console.log(error.message);
    }
}

// ØªØ§Ø¨Ø¹ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¯Ø± Ø¬Ø¯ÙˆÙ„
function renderTable() {
    const tableBody = document.getElementById("userTable");
    tableBody.innerHTML = "";

    // Ø¬Ø³ØªØ¬Ùˆ Ùˆ ØµÙØ­Ù‡â€ŒØ¨Ù†Ø¯ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
    let filteredData = searchUsers(usersData);
    let paginatedData = paginate(filteredData);

    paginatedData.forEach(user => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${user.name}</td>
            <td>${convertToPersianDate(user.createdAt)}</td>
            <td>${getUserRole(user.email)}</td>
            <td>
                <button class="btn btn-danger btn-sm" onclick="deleteUser(${user.id})">Ø­Ø°Ù</button>
            </td>
        `;
        tableBody.appendChild(tr);
    });

    renderPagination(filteredData.length);
}

// ØªØ§Ø¨Ø¹ ØªØ¨Ø¯ÛŒÙ„ ØªØ§Ø±ÛŒØ® Ù…ÛŒÙ„Ø§Ø¯ÛŒ Ø¨Ù‡ Ø´Ù…Ø³ÛŒ
function convertToPersianDate(isoDate) {
    const date = new Date(isoDate);
    return new Intl.DateTimeFormat("fa-IR", {
        year: "numeric",
        month: "long",
        day: "numeric",
    }).format(date);
}

// ØªØ§Ø¨Ø¹ ØªØ¹ÛŒÛŒÙ† Ù†Ù‚Ø´ Ú©Ø§Ø±Ø¨Ø± Ø¨Ø± Ø§Ø³Ø§Ø³ Ø§ÛŒÙ…ÛŒÙ„
function getUserRole(email) {
    if (email.includes("admin")) return "Ù…Ø¯ÛŒØ±";
    if (email.includes("staff")) return "Ú©Ø§Ø±Ù…Ù†Ø¯";
    return "Ú©Ø§Ø±Ø¨Ø± Ø¹Ø§Ø¯ÛŒ";
}

// ØªØ§Ø¨Ø¹ Ø­Ø°Ù Ú©Ø§Ø±Ø¨Ø±
async function deleteUser(userId) {
    try {
        const response = await fetch(`http://localhost:5000/api/user/${userId}`, {
            method: "DELETE",
        });

        if (!response.ok) throw new Error("Ø­Ø°Ù Ú©Ø§Ø±Ø¨Ø± Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯!");

        usersData = usersData.filter(user => user.id !== userId);
        renderTable(); // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¬Ø¯ÙˆÙ„ Ù¾Ø³ Ø§Ø² Ø­Ø°Ù

    } catch (error) {
        console.log(error.message);
    }
}

// ØªØ§Ø¨Ø¹ Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
function sortTable(column) {
    let order = column === "name" ? "asc" : "desc";

    usersData.sort((a, b) => {
        let valA = column === "name" ? a.name.toLowerCase() : new Date(a.createdAt);
        let valB = column === "name" ? b.name.toLowerCase() : new Date(b.createdAt);

        return order === "asc" ? (valA > valB ? 1 : -1) : (valA < valB ? 1 : -1);
    });

    renderTable();
}

// ØªØ§Ø¨Ø¹ ØµÙØ­Ù‡â€ŒØ¨Ù†Ø¯ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
function paginate(data) {
    const start = (currentPage - 1) * rowsPerPage;
    const end = start + rowsPerPage;
    return data.slice(start, end);
}

// ØªØ§Ø¨Ø¹ Ø¬Ø³ØªØ¬ÙˆÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†Ø§Ù…
function searchUsers(data) {
    const searchInput = document.getElementById("searchInput").value.toLowerCase();
    return data.filter(user => user.name.toLowerCase().includes(searchInput));
}

// ØªØ§Ø¨Ø¹ Ù…Ø¯ÛŒØ±ÛŒØª ØµÙØ­Ù‡â€ŒØ¨Ù†Ø¯ÛŒ
function changePage(page) {
    currentPage = page;
    renderTable();
}

// ØªØ§Ø¨Ø¹ Ù†Ù…Ø§ÛŒØ´ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ ØµÙØ­Ù‡â€ŒØ¨Ù†Ø¯ÛŒ
function renderPagination(totalItems) {
    const pagination = document.getElementById("pagination");
    pagination.innerHTML = "";

    let totalPages = Math.ceil(totalItems / rowsPerPage);

    for (let i = 1; i <= totalPages; i++) {
        pagination.innerHTML += `
            <li class="page-item ${i === currentPage ? "active" : ""}">
                <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
            </li>
        `;
    }
}

// Ø§Ø¬Ø±Ø§ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ø¨Ø±Ø§ÛŒ Ù¾Ø± Ú©Ø±Ø¯Ù† Ø¬Ø¯ÙˆÙ„
fetchAndPopulateTable();

</script>
    



<%- include('./layout/footer'); %>
