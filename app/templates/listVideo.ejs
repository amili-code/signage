<%- include('./layout/head'); %>

<main class="main">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/">Ø®Ø§Ù†Ù‡</a></li>
        <li class="breadcrumb-item active">ÙˆÛŒØ¯ÛŒÙˆÙ‡Ø§</li>
        <li class="breadcrumb-item ">Ù„ÛŒØ³Øª ÙˆÛŒØ¯ÛŒÙˆ</li>
    </ol>

    <div class="container-fluid">
        <div class="animated fadeIn">
            <div class="row container-fluid" id="videoList">
                <input type="text" id="searchInput" class="form-control mb-3 input-sm" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¹Ù†ÙˆØ§Ù† ÙˆÛŒØ¯ÛŒÙˆ..." oninput="renderTable()">
                <br>
                <div class="card">
                    <div class="card-header">
                        <i class="fa fa-align-justify"></i> Ø¬Ø¯ÙˆÙ„ <strong>ÙˆÛŒØ¯ÛŒÙˆÙ‡Ø§</strong>
                    </div>
                    <div class="card-body">
                        <table class="table table-condensed">
                            <thead>
                                <tr>
                                    <th>ØªØµÙˆÛŒØ±</th>
                                    <th onclick="sortTable('title')" style="cursor:pointer">Ø¹Ù†ÙˆØ§Ù† ÙˆÛŒØ¯ÛŒÙˆ ğŸ”½</th>
                                    <th>Ø±Ø²ÙˆÙ„ÙˆØ´Ù†</th>
                                    <th>Ù…Ø¯Øª Ø²Ù…Ø§Ù†</th>
                                    <th onclick="sortTable('createdAt')" style="cursor:pointer">ØªØ§Ø±ÛŒØ® Ø§ÛŒØ¬Ø§Ø¯ ğŸ”½</th>
                                    <th>ÙˆÛŒØ±Ø§ÛŒØ´</th>
                                    <th>Ø­Ø°Ù</th>
                                </tr>
                            </thead>
                            <tbody id="videoTable"></tbody>
                        </table>
                        <div class="row" style="text-align: center;">
                            <ul id="pagination" class="pagination"></ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div> 
</main>

<!-- Modal for editing video title -->
<div class="modal fade" id="editTitleModal" tabindex="-1" role="dialog" aria-labelledby="editTitleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editTitleModalLabel">ÙˆÛŒØ±Ø§ÛŒØ´ Ø¹Ù†ÙˆØ§Ù† ÙˆÛŒØ¯ÛŒÙˆ</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Ø¨Ø³ØªÙ†">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <input type="text" id="videoTitleInput" class="form-control" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø¬Ø¯ÛŒØ¯ ÙˆÛŒØ¯ÛŒÙˆ">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Ø¨Ø³ØªÙ†</button>
                <button type="button" class="btn btn-primary" id="saveTitleButton">Ø°Ø®ÛŒØ±Ù‡</button>
            </div>
        </div>
    </div>
</div>

<script>
    let videoData = []; // Ø°Ø®ÛŒØ±Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙˆÛŒØ¯ÛŒÙˆÙ‡Ø§
    let currentPage = 1;
    const rowsPerPage = 5; // ØªØ¹Ø¯Ø§Ø¯ ÙˆÛŒØ¯ÛŒÙˆÙ‡Ø§ Ø¯Ø± Ù‡Ø± ØµÙØ­Ù‡
    let currentEditVideoId = null;

    // Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø§Ø² API Ùˆ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø± Ø¬Ø¯ÙˆÙ„
    async function fetchAndPopulateTable() {
        try {
            const response = await fetch("http://localhost:5000/api/video");
            if (!response.ok) throw new Error("Ù…Ø´Ú©Ù„ÛŒ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ù‡ ÙˆØ¬ÙˆØ¯ Ø¢Ù…Ø¯Ù‡ Ø§Ø³Øª.");
            videoData = await response.json();
            renderTable();
        } catch (error) {
            console.log(error.message);
        }
    }

    // Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¯Ø± Ø¬Ø¯ÙˆÙ„
    function renderTable() {
        const tableBody = document.getElementById("videoTable");
        tableBody.innerHTML = "";

        let filteredData = searchVideos(videoData);
        let paginatedData = paginate(filteredData);

        paginatedData.forEach(video => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
            <td>
                <img src="http://localhost:5000/api/thumbnail/${video.originalName}" alt="Thumbnail" width="80">
                </td>
                <td>${video.title}</td>
                <td>${video.resolution}</td>
                <td>${video.duration.toFixed(2)} Ø«Ø§Ù†ÛŒÙ‡</td>
                <td>${convertToPersianDate(video.createdAt)}</td>
                <td>
                    <button class="btn btn-warning btn-sm" onclick="openEditTitleModal(${video.id}, '${video.title}')">ÙˆÛŒØ±Ø§ÛŒØ´</button>
                </td>
                <td>
                    <button class="btn btn-danger btn-sm" onclick="deleteVideo(${video.id})">Ø­Ø°Ù</button>
                </td>
            `;
            tableBody.appendChild(tr);
        });

        renderPagination(filteredData.length);
    }

    // ØªØ¨Ø¯ÛŒÙ„ ØªØ§Ø±ÛŒØ® Ù…ÛŒÙ„Ø§Ø¯ÛŒ Ø¨Ù‡ Ø´Ù…Ø³ÛŒ
    function convertToPersianDate(isoDate) {
        const date = new Date(isoDate);
        return new Intl.DateTimeFormat("fa-IR", {
            year: "numeric",
            month: "long",
            day: "numeric",
        }).format(date);
    }

    // Ø­Ø°Ù ÙˆÛŒØ¯ÛŒÙˆ
    async function deleteVideo(videoId) {
        if (!confirm("Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§ÛŒÙ† ÙˆÛŒØ¯ÛŒÙˆ Ø±Ø§ Ø­Ø°Ù Ú©Ù†ÛŒØ¯ØŸ")) return;

        try {
            const response = await fetch(`http://localhost:5000/api/video/${videoId}`, {
                method: "DELETE",
            });

            if (!response.ok) throw new Error("Ø­Ø°Ù ÙˆÛŒØ¯ÛŒÙˆ Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯!");

            videoData = videoData.filter(video => video.id !== videoId);
            renderTable(); // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¬Ø¯ÙˆÙ„ Ù¾Ø³ Ø§Ø² Ø­Ø°Ù

        } catch (error) {
            console.log(error.message);
        }
    }

    // ØªØ§Ø¨Ø¹ Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ø¬Ø¯ÙˆÙ„
    function sortTable(column) {
        let order = column === "title" ? "asc" : "desc";

        videoData.sort((a, b) => {
            let valA = column === "title" ? a.title.toLowerCase() : new Date(a.createdAt);
            let valB = column === "title" ? b.title.toLowerCase() : new Date(b.createdAt);

            return order === "asc" ? (valA > valB ? 1 : -1) : (valA < valB ? 1 : -1);
        });

        renderTable();
    }

    // ØªØ§Ø¨Ø¹ ØµÙØ­Ù‡â€ŒØ¨Ù†Ø¯ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
    function paginate(data) {
        const start = (currentPage - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        return data.slice(start, end);
    }

    // ØªØ§Ø¨Ø¹ Ø¬Ø³ØªØ¬ÙˆÛŒ ÙˆÛŒØ¯ÛŒÙˆÙ‡Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¹Ù†ÙˆØ§Ù†
    function searchVideos(data) {
        const searchInput = document.getElementById("searchInput").value.toLowerCase();
        return data.filter(video => video.title.toLowerCase().includes(searchInput));
    }

    // ØªØ§Ø¨Ø¹ ØªØºÛŒÛŒØ± ØµÙØ­Ù‡
    function changePage(page) {
        currentPage = page;
        renderTable();
    }

    // ØªØ§Ø¨Ø¹ Ù†Ù…Ø§ÛŒØ´ ØµÙØ­Ù‡â€ŒØ¨Ù†Ø¯ÛŒ
    function renderPagination(totalItems) {
        const pagination = document.getElementById("pagination");
        pagination.innerHTML = "";

        let totalPages = Math.ceil(totalItems / rowsPerPage);

        for (let i = 1; i <= totalPages; i++) {
            pagination.innerHTML += `
                <li class="page-item ${i === currentPage ? "active" : ""}">
                    <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
                </li>
            `;
        }
    }

    // Ù†Ù…Ø§ÛŒØ´ Ù…ÙˆØ¯Ø§Ù„ ÙˆÛŒØ±Ø§ÛŒØ´ Ø¹Ù†ÙˆØ§Ù† ÙˆÛŒØ¯ÛŒÙˆ
    function openEditTitleModal(videoId, currentTitle) {
        currentEditVideoId = videoId;
        document.getElementById('videoTitleInput').value = currentTitle;
        $('#editTitleModal').modal('show');
    }

    // Ø°Ø®ÛŒØ±Ù‡ Ø¹Ù†ÙˆØ§Ù† Ø¬Ø¯ÛŒØ¯ ÙˆÛŒØ¯ÛŒÙˆ
    document.getElementById('saveTitleButton').addEventListener('click', async function () {
        const newTitle = document.getElementById('videoTitleInput').value;
        if (!newTitle || newTitle.trim() === "") {
            alert("Ø¹Ù†ÙˆØ§Ù† ÙˆÛŒØ¯ÛŒÙˆ Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø®Ø§Ù„ÛŒ Ø¨Ø§Ø´Ø¯");
            return;
        }

        try {
            const response = await fetch(`http://localhost:5000/api/video/${currentEditVideoId}`, {
                method: "PUT",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({ title: newTitle }),
            });

            if (!response.ok) throw new Error("Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¹Ù†ÙˆØ§Ù† ÙˆÛŒØ¯ÛŒÙˆ Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯!");

            $('#editTitleModal').modal('hide');
            fetchAndPopulateTable();
        } catch (error) {
            console.log(error.message);
        }
    });

    // Ø§Ø¬Ø±Ø§ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
    fetchAndPopulateTable();
</script>

<%- include('./layout/footer'); %>